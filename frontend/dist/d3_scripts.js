import{trainModel}from"./logisticModel.js";document.addEventListener("DOMContentLoaded",(async function(){console.log("d3 script fires");const t=JSON.parse(sessionStorage.getItem("gameData"));t?console.log("Data loaded from sessionStorage"):(t=await fetchData(),console.log("data loaded from api"));try{const e=await trainModel();console.log("predictions in the d3",e),updateVisualization(t,e)}catch(t){console.error("error during training",t)}}));export function updateVisualization(t,e){console.log("data log",t.allUserData),console.log("predictions",e);const a=t.allUserData;d3.select("#d3-visualization").select("svg").remove();const o=530,l=d3.select("#d3-visualization").append("svg").attr("width","100%").attr("height",600).attr("viewBox","0 0 1000 600").style("background-color","rgba(240, 240, 240, 0.5)").append("g").attr("transform","translate(50,20)"),s=d3.scaleLinear().range([0,920]),n=d3.scaleLinear().range([o,0]);s.domain(d3.extent(a,(t=>t.total_plays))),n.domain(d3.extent(a,(t=>t.total_eggs))),l.append("g").attr("transform","translate(0,530)").call(d3.axisBottom(s)),l.append("g").call(d3.axisLeft(n));const r=d3.select("#d3-visualization").append("div").attr("class","tooltip").style("opacity",0);l.selectAll(".dot").data(a).enter().append("circle").attr("class","dot").attr("cx",(t=>s(t.total_plays))).attr("cy",(t=>n(t.total_eggs))).attr("r",5).attr("fill","black").on("mouseover",(function(t,e){r.style("opacity",1).html(`Play Count: ${e.total_plays}<br>Eggs Collected: ${e.total_eggs}`).style("left",`${t.pageX+10}px`).style("top",t.pageY-10+"px")})).on("mousemove",(function(t,e){r.style("left",`${t.pageX+10}px`).style("top",t.pageY-10+"px")})).on("mouseout",(function(){r.style("opacity",0)}));const i=a.map(((t,a)=>({username:t.user_id,prediction:e[a]?.toFixed(2)||"N/A"}))),d=d3.scaleBand().domain(i.map((t=>t.username))).range([0,920]).padding(.1),c=d3.scaleLinear().domain([0,1]).range([o,0]);d3.select("#logistic-predictions-section").select("svg").remove();const p=d3.select("#logistic-predictions-section").append("svg").attr("width","100%").attr("height",600).attr("viewBox","0 0 1000 600").style("background-color","rgba(240, 240, 240, 0.5)").append("g").attr("transform","translate(50,20)");p.append("g").attr("transform","translate(0,530)").call(d3.axisBottom(d)),p.append("g").call(d3.axisLeft(c));const g=d3.scaleLinear().domain([0,1]).range(["steelblue","red"]),u=d3.select("#logistic-predictions-section").append("div").attr("class","tooltip").style("opacity",0);p.selectAll(".dot").data(i).enter().append("circle").attr("class","dot").attr("cx",(t=>d(t.username)+d.bandwidth()/2)).attr("cy",((t,e)=>c(t.prediction))).attr("r",5).style("fill",((t,e)=>g(t.prediction))).on("mouseover",(function(t,e){u.style("opacity",1).html(`Username: ${e.username}<br>Predicted Win Probability: ${e.prediction}`).style("left",`${t.pageX+10}px`).style("top",t.pageY-10+"px")})).on("mouseout",(function(){u.style("opacity",0)})),p.append("text").attr("transform","rotate(-90)").attr("x",-230).attr("y",-40).attr("text-anchor","middle").text("Predicted Probability");const m=a.sort(((t,e)=>e.win-t.win)).slice(0,3);d3.select("#league-table tbody").selectAll("tr").data(m).enter().append("tr").html(((t,e)=>`\n                <tr>\n                    <td>${e+1}</td>\n                    <td>${t.user_id}</td>\n                    <td>${t.win}</td>\n                </tr>\n            `));const y=d3.select("#user-rank");document.getElementById("search-box").addEventListener("input",(function(){const t=this.value.toLowerCase(),e=a.filter((e=>e.user_id.toLowerCase().includes(t))),o=i.filter((e=>e.username.toLowerCase().includes(t)));l.selectAll(".dot").data(e).join((t=>t.append("circle").attr("class","dot")),(t=>t),(t=>t.remove())).attr("cx",(t=>s(t.total_plays))).attr("cy",(t=>n(t.total_eggs))).attr("r",5).attr("fill","red").on("mouseover",(function(t,e){r.style("opacity",1).html(`Play Count: ${e.total_plays}<br>Eggs Collected: ${e.total_eggs}`).style("left",`${t.pageX+10}px`).style("top",t.pageY-10+"px")})).on("mousemove",(function(t,e){r.style("left",`${t.pageX+10}px`).style("top",t.pageY-10+"px")})).on("mouseout",(function(){r.style("opacity",0)})),p.selectAll(".dot").data(o).join((t=>t.append("circle").attr("class","dot")),(t=>t),(t=>t.remove())).attr("cx",(t=>d(t.username)+d.bandwidth()/2)).attr("cy",(t=>c(t.prediction))).attr("r",5).style("fill",(t=>"N/A"===t.prediction?"gray":"steelblue"));const g=a.find((e=>e.user_id.toLowerCase()===t)),u=d3.selectAll("#league-table tbody tr");u.classed("highlight",!1),g?(y.html(`User: ${g.user_id}<br>Rank: ${a.indexOf(g)+1}<br>Wins: ${g.win}`),u.filter((e=>e.user_id.toLowerCase()===t)).classed("highlight",!0)):y.html("User not found")}))}